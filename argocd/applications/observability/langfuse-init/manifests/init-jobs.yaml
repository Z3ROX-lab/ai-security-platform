# Langfuse Database Initialization Job
---
apiVersion: batch/v1
kind: Job
metadata:
  name: langfuse-db-init
  namespace: storage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: false
      containers:
        - name: init-db
          image: postgres:15
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
          env:
            - name: PGHOST
              value: "postgresql-rw.storage.svc.cluster.local"
            - name: PGUSER
              value: "postgres"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-superuser
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Creating Langfuse database and user..."
              
              # Create user if not exists
              psql -tc "SELECT 1 FROM pg_roles WHERE rolname='langfuse'" | grep -q 1 || \
                psql -c "CREATE USER langfuse WITH PASSWORD 'langfuse-password';"
              
              # Create database if not exists
              psql -tc "SELECT 1 FROM pg_database WHERE datname='langfuse'" | grep -q 1 || \
                psql -c "CREATE DATABASE langfuse OWNER langfuse;"
              
              # Grant privileges
              psql -c "GRANT ALL PRIVILEGES ON DATABASE langfuse TO langfuse;"
              
              echo "Langfuse database initialized successfully!"
---
# Langfuse S3 Bucket Initialization Job
apiVersion: batch/v1
kind: Job
metadata:
  name: langfuse-s3-init
  namespace: storage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: false
      containers:
        - name: init-s3
          image: amazon/aws-cli:2.13.0
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
          env:
            - name: AWS_ACCESS_KEY_ID
              value: "admin"
            - name: AWS_SECRET_ACCESS_KEY
              value: "admin123"
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Creating Langfuse S3 bucket..."
              
              # Create bucket (ignore if exists)
              aws --endpoint-url http://seaweedfs-s3.storage.svc.cluster.local:8333 \
                s3 mb s3://langfuse || echo "Bucket may already exist"
              
              # List buckets to verify
              aws --endpoint-url http://seaweedfs-s3.storage.svc.cluster.local:8333 \
                s3 ls
              
              echo "Langfuse S3 bucket ready!"
