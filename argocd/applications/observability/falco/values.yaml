# Falco - Runtime Security Monitoring
# Detects threats, anomalies, and suspicious syscalls

# =============================================================================
# Falco Configuration
# =============================================================================
falco:
  # Rules priority (emergency, alert, critical, error, warning, notice, info, debug)
  priority: warning
  
  # JSON output for Loki/Grafana
  jsonOutput: true
  jsonIncludeOutputProperty: true
  
  # Log to stdout (collected by Promtail)
  logStderr: true
  logSyslog: false
  
  # Grpc for falcosidekick
  grpc:
    enabled: true
    threadiness: 8
  
  grpcOutput:
    enabled: true

# =============================================================================
# Driver - eBPF (modern, no kernel module)
# =============================================================================
driver:
  kind: modern_ebpf
  modernEbpf:
    leastPrivileged: true

# =============================================================================
# Resources
# =============================================================================
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# =============================================================================
# Tolerations - run on all nodes
# =============================================================================
tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# =============================================================================
# Custom Rules for AI Platform
# =============================================================================
customRules:
  ai-platform-rules.yaml: |-
    # Detect attempts to access LLM model files
    - rule: Suspicious Access to Model Files
      desc: Detect attempts to read model files outside normal inference
      condition: >
        open_read and 
        container and 
        fd.name contains "/models/" and
        not proc.name in (ollama, python, python3)
      output: >
        Suspicious model file access 
        (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name)
      priority: WARNING
      tags: [ai-security, model-theft, OWASP-LLM10]

    # Detect potential data exfiltration from AI namespace
    - rule: AI Namespace Network Anomaly
      desc: Detect unexpected outbound connections from AI components
      condition: >
        outbound and 
        container and 
        k8s.ns.name in (ai-inference, ai-apps) and
        not fd.sip in (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
      output: >
        Unexpected external connection from AI component 
        (user=%user.name command=%proc.cmdline connection=%fd.name container=%container.name namespace=%k8s.ns.name)
      priority: WARNING
      tags: [ai-security, data-exfiltration, network]

    # Detect shell spawned in AI containers
    - rule: Shell in AI Container
      desc: Detect interactive shell in AI inference containers
      condition: >
        spawned_process and 
        container and
        k8s.ns.name in (ai-inference, ai-apps) and
        proc.name in (bash, sh, dash, zsh)
      output: >
        Shell spawned in AI container 
        (user=%user.name shell=%proc.name parent=%proc.pname container=%container.name namespace=%k8s.ns.name)
      priority: NOTICE
      tags: [ai-security, container-escape]

    # Detect secrets access
    - rule: Secret File Access in Container
      desc: Detect access to mounted secrets
      condition: >
        open_read and
        container and
        fd.name startswith "/var/run/secrets/"
      output: >
        Secret file accessed 
        (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name)
      priority: NOTICE
      tags: [security, secrets]

# =============================================================================
# Falcosidekick - Forward alerts
# =============================================================================
falcosidekick:
  enabled: true
  
  config:
    # Forward to stdout (for Loki)
    debug: false
    
    # Webhook to Alertmanager (optional)
    # alertmanager:
    #   hostport: "http://alertmanager-operated.observability.svc:9093"
    
  resources:
    requests:
      cpu: 20m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

  webui:
    enabled: true
    resources:
      requests:
        cpu: 20m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi
